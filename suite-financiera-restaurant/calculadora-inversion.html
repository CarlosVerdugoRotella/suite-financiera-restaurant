<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora Financiera v2.29</title>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <style>
    /* ==================== VARIABLES CSS ==================== */
    :root {
      /* Base Neutra */
      --bg-primary: #FAFBFC;
      --bg-card: #FFFFFF;
      --border-default: #E5E7EB;
      --text-primary: #111827;
      --text-secondary: #6B7280;
      --text-tertiary: #9CA3AF;
      
      /* Acentos Funcionales */
      --primary: #1E40AF;
      --primary-hover: #1E3A8A;
      --success: #047857;
      --warning: #D97706;
      --error: #DC2626;
      
      /* Diferenciadores Tier */
      --tier-1: #4F46E5;
      --tier-2: #0891B2;
      --tier-3: #7C3AED;
      --tier-4: #DB2777;
      --tier-5: #059669;
      --controlador: #047857;
      
      /* Sombras */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.08);
      
      /* Espaciado */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 20px;
      
      /* Border Radius */
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
    }
    
    /* ==================== RESET Y BASE ==================== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 
                   'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    
    /* ==================== LAYOUT PRINCIPAL ==================== */
    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-default);
      padding: var(--space-xl) var(--space-xl);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }
    
    .header-content {
      max-width: 1440px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--primary);
    }
    
    .header-actions {
      display: flex;
      gap: var(--space-md);
    }
    
    .container {
      max-width: 1440px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: var(--space-xl);
      padding: var(--space-xl);
      min-height: calc(100vh - 90px);
    }
    
    /* ==================== SIDEBAR ==================== */
    .sidebar {
      height: calc(100vh - 130px);
      overflow-y: auto;
      overflow-x: hidden;
      position: sticky;
      top: 110px;
      padding-right: 8px;
    }
    
    .sidebar::-webkit-scrollbar {
      width: 6px;
    }
    
    .sidebar::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .sidebar::-webkit-scrollbar-thumb {
      background: var(--border-default);
      border-radius: 3px;
    }
    
    .sidebar::-webkit-scrollbar-thumb:hover {
      background: var(--text-tertiary);
    }
    
    .input-section {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
      box-shadow: var(--shadow-md);
    }
    
    .section-title {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: var(--space-md);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid var(--border-default);
    }
    
    .input-group {
      margin-bottom: var(--space-md);
    }
    
    .input-group:last-child {
      margin-bottom: 0;
    }
    
    .input-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: var(--space-xs);
    }
    
    .input-group input,
    .input-group select {
      width: 100%;
      height: 34px;
      padding: 0 var(--space-md);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-family: inherit;
      background: var(--bg-card);
      color: var(--text-primary);
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      font-variant-numeric: tabular-nums;
    }
    
    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }
    
    .input-group input.error {
      border-color: var(--error);
    }
    
    .input-group input.warning {
      border-color: var(--warning);
    }
    
    .input-error-msg {
      font-size: 11px;
      color: var(--error);
      margin-top: 4px;
      display: none;
    }
    
    .input-error-msg.show {
      display: block;
    }
    
    .input-warning-msg {
      font-size: 11px;
      color: var(--warning);
      margin-top: 4px;
      display: none;
    }
    
    .input-warning-msg.show {
      display: block;
    }
    
    .input-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-md);
    }
    
    /* Tier Colapsable */
    .tier-section {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
      box-shadow: var(--shadow-md);
      border-left: 3px solid var(--tier-1);
    }
    
    .tier-section[data-tier-index="1"] { border-left-color: var(--tier-2); }
    .tier-section[data-tier-index="2"] { border-left-color: var(--tier-3); }
    .tier-section[data-tier-index="3"] { border-left-color: var(--tier-4); }
    .tier-section[data-tier-index="4"] { border-left-color: var(--tier-5); }
    
    .tier-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
      margin-bottom: var(--space-md);
    }
    
    .tier-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }
    
    .tier-actions {
      display: flex;
      gap: var(--space-sm);
    }
    
    .tier-btn-collapse,
    .tier-btn-delete {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: var(--radius-sm);
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }
    
    .tier-btn-collapse:hover,
    .tier-btn-delete:hover {
      background: #F3F4F6;
    }
    
    .tier-btn-delete:hover {
      color: var(--error);
    }
    
    .tier-content {
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .tier-content.collapsed {
      max-height: 0;
    }
    
    .btn-add-tier {
      width: 100%;
      height: 40px;
      border: 2px dashed var(--border-default);
      background: transparent;
      color: var(--text-secondary);
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: var(--space-lg);
    }
    
    .btn-add-tier:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: rgba(30, 64, 175, 0.05);
    }
    
    /* ==================== PANEL RESULTADOS ==================== */
    .results-panel {
      display: flex;
      flex-direction: column;
      gap: var(--space-xl);
    }
    
    /* M√©tricas Clave */
    .metrics-summary {
      background: linear-gradient(135deg, #EFF6FF 0%, #FFFFFF 100%);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 110px;
      z-index: 50;
    }
    
    .metrics-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: var(--space-md);
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: var(--space-lg);
    }
    
    .metric-item {
      text-align: center;
    }
    
    .metric-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: var(--space-xs);
      display: block;
    }
    
    .metric-value {
      font-size: 20px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      color: var(--text-primary);
    }
    
    .metric-value.highlight {
      color: var(--success);
    }
    
    .metric-subtext {
      font-size: 10px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }
    
    /* Cards Resultados */
    .result-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      box-shadow: var(--shadow-md);
      border-left: 3px solid var(--tier-1);
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }
    
    .result-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-1px);
    }
    
    .result-card[data-tier-index="1"] { border-left-color: var(--tier-2); }
    .result-card[data-tier-index="2"] { border-left-color: var(--tier-3); }
    .result-card[data-tier-index="3"] { border-left-color: var(--tier-4); }
    .result-card[data-tier-index="4"] { border-left-color: var(--tier-5); }
    
    .result-card.controlador-card {
      border-left-color: var(--controlador);
    }
    
    .card-header {
      margin-bottom: var(--space-lg);
    }
    
    .card-tier-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: var(--space-xs);
    }
    
    .card-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .card-title .amount {
      color: var(--success);
      font-size: 14px;
    }
    
    .card-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-lg);
      margin-bottom: var(--space-lg);
    }
    
    .card-metric {
      background: #F9FAFB;
      padding: var(--space-md);
      border-radius: var(--radius-md);
    }
    
    .card-metric-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: var(--space-xs);
      display: block;
    }
    
    .card-metric-value {
      font-size: 16px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      color: var(--text-primary);
    }
    
    .card-metric-value.highlight {
      color: var(--success);
    }
    
    .card-metric-value.text-warning-legal {
      color: var(--warning);
      background: #FEF3C7;
      padding: 2px 6px;
      border-radius: 3px;
    }
    
    .card-metric-subtext {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }
    
    .card-metric-subtext.warning-legal {
      color: var(--warning);
      font-weight: 600;
    }
    
    /* Detalle Mensual */
    .detalle-toggle {
      margin-top: var(--space-lg);
      padding-top: var(--space-lg);
      border-top: 1px solid var(--border-default);
    }
    
    .btn-toggle-detalle {
      background: transparent;
      border: 1px solid var(--border-default);
      color: var(--text-secondary);
      padding: 8px 16px;
      border-radius: var(--radius-md);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .btn-toggle-detalle:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .detalle-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .detalle-content.expanded {
      max-height: 2000px;
      margin-top: var(--space-lg);
    }
    
    .detalle-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .detalle-table th {
      text-align: left;
      padding: 8px;
      background: #F9FAFB;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 2px solid var(--border-default);
    }
    
    .detalle-table td {
      padding: 8px;
      border-bottom: 1px solid #F3F4F6;
      font-variant-numeric: tabular-nums;
    }
    
    .detalle-table tr:nth-child(even) {
      background: #FAFBFC;
    }
    
    .detalle-table tr.payback-row {
      background: #ECFDF5;
      font-weight: 600;
    }
    
    .btn-load-more {
      margin-top: var(--space-md);
      width: 100%;
      height: 34px;
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      color: var(--text-secondary);
      border-radius: var(--radius-md);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .btn-load-more:hover {
      background: #F9FAFB;
      border-color: var(--primary);
      color: var(--primary);
    }
    
    /* Gr√°fico */
    .chart-container {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      box-shadow: var(--shadow-md);
      height: 350px;
    }
    
    .chart-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-lg);
    }
    
    /* ==================== BOTONES ==================== */
    .btn {
      height: 34px;
      padding: 0 var(--space-lg);
      border: none;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-default);
    }
    
    .btn-secondary:hover {
      background: #F9FAFB;
    }
    
    /* ==================== UTILIDADES ==================== */
    .text-warning {
      color: var(--warning);
    }
    
    .text-error {
      color: var(--error);
    }
    
    .hidden {
      display: none;
    }
    
    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        position: static;
        height: auto;
        overflow-y: visible;
      }
      
      .metrics-summary {
        position: static;
      }
      
      .metrics-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .card-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 640px) {
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .card-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- ==================== HEADER ==================== -->
  <header class="header">
    <div class="header-content">
      <h1>üìä Modelo Financiero - <span id="displayNombreProyecto">Proyecto Sin Nombre</span></h1>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="volverAIngresos()">‚Üê Editar Ingresos</button>
        <button class="btn btn-secondary" id="btnLimpiar">Limpiar</button>
        <button class="btn btn-primary" id="btnExportar">Exportar PDF</button>
      </div>
    </div>
  </header>

  <!-- ==================== CONTENEDOR PRINCIPAL ==================== -->
  <div class="container" id="mainContainer">
    
    <!-- ==================== SIDEBAR INPUTS ==================== -->
    <aside class="sidebar">
      
      <!-- PROYECTO -->
      <section class="input-section">
        <div class="section-title">Proyecto</div>
        <div class="input-group">
          <label for="nombreProyecto">Nombre del Proyecto</label>
          <input type="text" id="nombreProyecto" placeholder="Ej: Restaurante XYZ">
        </div>
        <div class="input-grid-2">
          <div class="input-group">
            <label for="pctInversores">% Inversores</label>
            <input type="number" id="pctInversores" min="0" max="100" step="0.1" value="48">
          </div>
          <div class="input-group">
            <label for="pctControlador">% Controlador</label>
            <input type="number" id="pctControlador" min="0" max="100" step="0.1" value="52">
          </div>
        </div>
        <div class="input-error-msg" id="errorEquity">Los porcentajes deben sumar 100%</div>
      </section>

      <!-- INGRESOS -->
      <section class="input-section">
        <div class="section-title">Ingresos Mensuales por A√±o</div>
        <div class="input-group">
          <label for="ingresoA√±o1">A√±o 1 ($)</label>
          <input type="text" id="ingresoA√±o1" class="money-input" value="0">
        </div>
        <div class="input-group">
          <label for="ingresoA√±o2">A√±o 2 ($)</label>
          <input type="text" id="ingresoA√±o2" class="money-input" value="50000000">
        </div>
        <div class="input-group">
          <label for="ingresoA√±o3">A√±o 3 ($)</label>
          <input type="text" id="ingresoA√±o3" class="money-input" value="100000000">
        </div>
        <div class="input-group">
          <label for="ingresoA√±o4">A√±o 4 ($)</label>
          <input type="text" id="ingresoA√±o4" class="money-input" value="150000000">
        </div>
        <div class="input-group">
          <label for="ingresoA√±o5">A√±o 5+ (Estabilizaci√≥n) ($)</label>
          <input type="text" id="ingresoA√±o5" class="money-input" value="150000000">
        </div>
      </section>

      <!-- OPERACI√ìN -->
      <section class="input-section">
        <div class="section-title">Operaci√≥n</div>
        <div class="input-group">
          <label for="margenNeto">Margen Neto (%)</label>
          <input type="number" id="margenNeto" min="0" max="100" step="0.1" value="25">
        </div>
        <div class="input-group">
          <label for="pctDistribuir">% a Distribuir (%)</label>
          <input type="number" id="pctDistribuir" min="0" max="100" step="0.1" value="80">
        </div>
      </section>

      <!-- TIERS DIN√ÅMICOS -->
      <div id="tiersContainer"></div>
      
      <button class="btn-add-tier" id="btnAddTier">+ Agregar Tier</button>

      <!-- CONTROLADOR -->
      <section class="input-section">
        <div class="section-title">Controlador</div>
        <div class="input-group">
          <label for="ctrlCapitalInicial">Capital Inicial ($)</label>
          <input type="text" id="ctrlCapitalInicial" class="money-input" value="0">
        </div>
        <div class="input-group">
          <label for="ctrlTipoHolder">Tipo de Holder</label>
          <select id="ctrlTipoHolder">
            <option value="persona_natural">Persona Natural</option>
            <option value="empresa">Empresa</option>
          </select>
        </div>
        <div class="input-group">
          <label for="ctrlRetencion">% Retenci√≥n Impuestos (%)</label>
          <input type="number" id="ctrlRetencion" min="0" max="99" step="0.1" value="10">
        </div>
      </section>

      <!-- PAR√ÅMETROS FINANCIEROS -->
      <section class="input-section">
        <div class="section-title">Par√°metros Financieros</div>
        <div class="input-group">
          <label for="tasaDescuento">Tasa de Descuento Anual (%)</label>
          <input type="number" id="tasaDescuento" min="0" max="50" step="0.1" value="12">
        </div>
      </section>

    </aside>

    <!-- ==================== PANEL RESULTADOS ==================== -->
    <main class="results-panel">
      
      <!-- M√âTRICAS CLAVE -->
      <section class="metrics-summary">
        <div class="metrics-title">üìå M√©tricas Clave</div>
        <div class="metrics-grid">
          <div class="metric-item">
            <span class="metric-label">Capital Levantado</span>
            <div class="metric-value highlight" id="metricCapital">$0</div>
            <div class="metric-subtext" id="metricCapitalPct">‚Äî% equity</div>
          </div>
          <div class="metric-item">
            <span class="metric-label">Payback Promedio</span>
            <div class="metric-value" id="metricPayback">‚Äî meses</div>
            <div class="metric-subtext">Ponderado</div>
          </div>
          <div class="metric-item">
            <span class="metric-label">ROI Promedio</span>
            <div class="metric-value" id="metricROI">‚Äî%</div>
            <div class="metric-subtext">A√±o 5 estabilizado</div>
          </div>
          <div class="metric-item">
            <span class="metric-label">TIR Promedio</span>
            <div class="metric-value" id="metricTIR">‚Äî%</div>
            <div class="metric-subtext">10 a√±os</div>
          </div>
          <div class="metric-item">
            <span class="metric-label">VAN Total</span>
            <div class="metric-value highlight" id="metricVAN">$0</div>
            <div class="metric-subtext">Valor creado</div>
          </div>
          <div class="metric-item">
            <span class="metric-label">Valor Empresa</span>
            <div class="metric-value" id="metricValor">$0</div>
            <div class="metric-subtext">Valorizaci√≥n</div>
          </div>
        </div>
      </section>

      <!-- TIERS RESULTADOS (din√°mico) -->
      <div id="tiersResultsContainer"></div>

      <!-- CONTROLADOR RESULTADOS -->
      <section class="result-card controlador-card" id="controladorResults">
        <div class="card-header">
          <div class="card-tier-label">CONTROLADOR</div>
          <h2 class="card-title">Participaci√≥n Mayoritaria ¬∑ <span class="amount" id="ctrlResultPct">‚Äî%</span></h2>
        </div>
        
        <div class="card-grid">
          <div class="card-metric">
            <span class="card-metric-label">Valor Participaci√≥n</span>
            <div class="card-metric-value highlight" id="ctrlResultValor">$0</div>
            <div class="card-metric-subtext" id="ctrlResultPctSub">‚Äî% empresa</div>
          </div>
          <div class="card-metric">
            <span class="card-metric-label">Retiro Mensual NETO</span>
            <div class="card-metric-value highlight" id="ctrlResultRetiroNeto">$0</div>
            <div class="card-metric-subtext" id="ctrlResultRetiroBruto">Bruto: $0</div>
          </div>
          <div class="card-metric">
            <span class="card-metric-label">Utilidad Anual NETA</span>
            <div class="card-metric-value highlight" id="ctrlResultAnual">$0</div>
            <div class="card-metric-subtext">A√±o 5 estabilizado</div>
          </div>
          <div class="card-metric">
            <span class="card-metric-label">TIR</span>
            <div class="card-metric-value" id="ctrlResultTIR">N/A</div>
            <div class="card-metric-subtext">10 a√±os</div>
          </div>
          <div class="card-metric">
            <span class="card-metric-label">VAN</span>
            <div class="card-metric-value" id="ctrlResultVAN">N/A</div>
            <div class="card-metric-subtext">Valor creado</div>
          </div>
        </div>
      </section>

      <!-- GR√ÅFICO -->
      <section class="chart-container">
        <h3 class="chart-title">Proyecci√≥n VAN Acumulado (10 a√±os)</h3>
        <canvas id="vanChart"></canvas>
      </section>

    </main>

  </div>

  <!-- ==================== JAVASCRIPT ==================== -->
  <script>
    // ==================== ESTADO GLOBAL ====================
    let tiers = [];
    let nextTierId = 1;
    let vanChart = null;
    
    // ==================== UTILIDADES ====================
    
    function cleanNumber(str) {
      if (!str) return 0;
      return parseFloat(str.toString().replace(/\./g, '').replace(/[^0-9]/g, '')) || 0;
    }
    
    function formatMoney(num) {
      return new Intl.NumberFormat('es-CL', {
        style: 'currency',
        currency: 'CLP',
        maximumFractionDigits: 0
      }).format(num);
    }
    
    function formatMoneyShort(num) {
      if (num >= 1000000) {
        return '$' + (num / 1000000).toFixed(1) + 'M';
      }
      return formatMoney(num);
    }
    
    function formatPercent(num, decimals = 1) {
      return (num * 100).toFixed(decimals) + '%';
    }
    
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }
    
    function getA√±oFromMes(mes) {
      return Math.ceil(mes / 12);
    }
    
    // ==================== VALIDACIONES ====================
    
    function validarEquity() {
      const pctInv = parseFloat(document.getElementById('pctInversores').value) || 0;
      const pctCtrl = parseFloat(document.getElementById('pctControlador').value) || 0;
      const suma = pctInv + pctCtrl;
      
      const errorEl = document.getElementById('errorEquity');
      const inputInv = document.getElementById('pctInversores');
      const inputCtrl = document.getElementById('pctControlador');
      
      if (Math.abs(suma - 100) > 0.01) {
        errorEl.classList.add('show');
        inputInv.classList.add('error');
        inputCtrl.classList.add('error');
        return false;
      } else {
        errorEl.classList.remove('show');
        inputInv.classList.remove('error');
        inputCtrl.classList.remove('error');
        return true;
      }
    }
    
    // ==================== DETECCI√ìN Y CARGA DESDE CALCULADORA INGRESOS ====================
    
    function detectarYCargarIngresos() {
      try {
        const datosStr = localStorage.getItem('suite_ingresos_transfer');
        if (!datosStr) return false;
        
        const datos = JSON.parse(datosStr);
        
        // Validar estructura
        if (!datos.ingresosMensuales || datos.ingresosMensuales.length !== 5) {
          console.warn('Datos de ingresos incompletos');
          return false;
        }
        
        // Mostrar banner de confirmaci√≥n
        const confirmacion = confirm(
          'üìä DATOS DETECTADOS desde Calculadora Ingresos m¬≤\n\n' +
          `Ingresos mensuales proyectados:\n` +
          `¬∑ A√±o 1: ${formatMoney(datos.ingresosMensuales[0])}\n` +
          `¬∑ A√±o 2: ${formatMoney(datos.ingresosMensuales[1])}\n` +
          `¬∑ A√±o 3: ${formatMoney(datos.ingresosMensuales[2])}\n` +
          `¬∑ A√±o 4: ${formatMoney(datos.ingresosMensuales[3])}\n` +
          `¬∑ A√±o 5: ${formatMoney(datos.ingresosMensuales[4])}\n\n` +
          `Capacidad: ${datos.totalSillas} sillas | ${datos.comensalesDia} comensales/d√≠a\n\n` +
          '¬øCargar estos valores en la calculadora?'
        );
        
        if (!confirmacion) return false;
        
        // Cargar valores en inputs
        document.getElementById('ingresoA√±o1').value = datos.ingresosMensuales[0].toLocaleString('es-CL');
        document.getElementById('ingresoA√±o2').value = datos.ingresosMensuales[1].toLocaleString('es-CL');
        document.getElementById('ingresoA√±o3').value = datos.ingresosMensuales[2].toLocaleString('es-CL');
        document.getElementById('ingresoA√±o4').value = datos.ingresosMensuales[3].toLocaleString('es-CL');
        document.getElementById('ingresoA√±o5').value = datos.ingresosMensuales[4].toLocaleString('es-CL');
        
        // Mostrar banner sticky
        mostrarBannerIngresos(datos);
        
        // Calcular con nuevos datos
        calcularTodo();
        
        return true;
      } catch (error) {
        console.error('Error al cargar ingresos:', error);
        return false;
      }
    }
    
    function mostrarBannerIngresos(datos) {
      // Crear banner informativo sticky
      const banner = document.createElement('div');
      banner.id = 'banner-ingresos-cargados';
      banner.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
        border: 2px solid #1E40AF;
        border-radius: 8px;
        padding: 16px 24px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 13px;
        max-width: 600px;
        animation: slideDown 0.3s ease;
      `;
      
      banner.innerHTML = `
        <span style="font-size: 24px;">üìä</span>
        <div style="flex: 1;">
          <div style="font-weight: 600; color: #1E40AF; margin-bottom: 4px;">
            Datos cargados desde Calculadora Ingresos
          </div>
          <div style="font-size: 12px; color: #6B7280;">
            ${datos.totalSillas} sillas ¬∑ ${datos.comensalesDia} comensales/d√≠a ¬∑
            Ingresos desde ${formatMoneyShort(datos.ingresosMensuales[0])} hasta 
            ${formatMoneyShort(datos.ingresosMensuales[4])}/mes
          </div>
        </div>
        <button onclick="cerrarBannerIngresos()" style="
          background: transparent;
          border: none;
          color: #6B7280;
          font-size: 20px;
          cursor: pointer;
          padding: 0;
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 4px;
          transition: background 0.15s;
        " onmouseover="this.style.background='#F3F4F6'" 
           onmouseout="this.style.background='transparent'">√ó</button>
      `;
      
      // Agregar CSS animaci√≥n
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideDown {
          from {
            opacity: 0;
            transform: translate(-50%, -20px);
          }
          to {
            opacity: 1;
            transform: translate(-50%, 0);
          }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(banner);
      
      // Auto-cerrar despu√©s de 8 segundos
      setTimeout(() => {
        cerrarBannerIngresos();
      }, 8000);
    }
    
    function cerrarBannerIngresos() {
      const banner = document.getElementById('banner-ingresos-cargados');
      if (banner) {
        banner.style.animation = 'slideDown 0.3s ease reverse';
        setTimeout(() => banner.remove(), 300);
      }
    }
    
    function limpiarDatosTransferencia() {
      try {
        localStorage.removeItem('suite_ingresos_transfer');
        console.log('Datos de transferencia limpiados');
      } catch (error) {
        console.error('Error al limpiar localStorage:', error);
      }
    }
    
    function volverAIngresos() {
      if (confirm('¬øVolver a la Calculadora de Ingresos?\n\nLos datos actuales de inversi√≥n no se guardar√°n.')) {
        window.location.href = 'calculadora-ingresos-m2.html';
      }
    }
    
    // ==================== GESTI√ìN DE TIERS ====================
    
    function agregarTier() {
      if (tiers.length >= 6) {
        alert('M√°ximo 6 tiers permitidos');
        return;
      }
      
      const tier = {
        id: nextTierId++,
        nombre: `Tier ${tiers.length + 1}`,
        cantidad: 1,
        monto: 10000000,
        mesInversion: 0,
        mesRetornos: 12,
        tipoHolder: 'persona_natural',
        retencion: 10,
        collapsed: false
      };
      
      tiers.push(tier);
      renderTiers();
      calcularTodo();
    }
    
    function eliminarTier(id) {
      if (tiers.length <= 1) {
        alert('Debe haber al menos 1 tier');
        return;
      }
      
      if (!confirm('¬øEliminar este tier?')) return;
      
      tiers = tiers.filter(t => t.id !== id);
      renderTiers();
      calcularTodo();
    }
    
    function toggleCollapseTier(id) {
      const tier = tiers.find(t => t.id === id);
      if (tier) {
        tier.collapsed = !tier.collapsed;
        renderTiers();
      }
    }
    
    function actualizarTier(id, field, value) {
      const tier = tiers.find(t => t.id === id);
      if (!tier) return;
      
      tier[field] = value;
      
      // Validar mesRetornos >= mesInversion
      if (field === 'mesRetornos' || field === 'mesInversion') {
        if (tier.mesRetornos < tier.mesInversion) {
          tier.mesRetornos = tier.mesInversion + 1;
          renderTiers();
          alert('El mes de inicio de retornos debe ser posterior al mes de inversi√≥n. Se ajust√≥ autom√°ticamente.');
        }
      }
      
      calcularTodo();
    }
    
    function renderTiers() {
      const container = document.getElementById('tiersContainer');
      container.innerHTML = '';
      
      tiers.forEach((tier, index) => {
        const tierEl = document.createElement('section');
        tierEl.className = 'tier-section';
        tierEl.setAttribute('data-tier-index', index);
        
        // Validar meses
        const mesWarning = tier.mesRetornos <= tier.mesInversion;
        
        tierEl.innerHTML = `
          <div class="tier-header" onclick="toggleCollapseTier(${tier.id})">
            <div class="tier-title">${tier.nombre || 'Tier ' + (index + 1)}</div>
            <div class="tier-actions">
              <button class="tier-btn-collapse" onclick="event.stopPropagation(); toggleCollapseTier(${tier.id})">
                ${tier.collapsed ? '‚ñº' : '‚ñ≤'}
              </button>
              <button class="tier-btn-delete" onclick="event.stopPropagation(); eliminarTier(${tier.id})">
                √ó
              </button>
            </div>
          </div>
          
          <div class="tier-content ${tier.collapsed ? 'collapsed' : ''}">
            <div class="input-group">
              <label>Nombre del Tier</label>
              <input type="text" value="${tier.nombre}" 
                     onchange="actualizarTier(${tier.id}, 'nombre', this.value)">
            </div>
            <div class="input-group">
              <label>Cantidad de Inversionistas</label>
              <input type="number" min="1" step="1" value="${tier.cantidad}"
                     onchange="actualizarTier(${tier.id}, 'cantidad', parseInt(this.value) || 1)">
            </div>
            <div class="input-group">
              <label>Inversi√≥n Individual ($)</label>
              <input type="text" class="money-input" value="${tier.monto.toLocaleString('es-CL')}"
                     data-tier-id="${tier.id}" data-field="monto">
            </div>
            <div class="input-group">
              <label>Mes de Inversi√≥n</label>
              <input type="number" min="0" max="24" step="1" value="${tier.mesInversion}"
                     class="${mesWarning ? 'warning' : ''}"
                     onchange="actualizarTier(${tier.id}, 'mesInversion', parseInt(this.value) || 0)">
            </div>
            <div class="input-group">
              <label>Mes Inicio Retornos</label>
              <input type="number" min="0" max="36" step="1" value="${tier.mesRetornos}"
                     class="${mesWarning ? 'warning' : ''}"
                     onchange="actualizarTier(${tier.id}, 'mesRetornos', parseInt(this.value) || 0)">
              <div class="input-warning-msg ${mesWarning ? 'show' : ''}">
                Debe ser mayor al mes de inversi√≥n
              </div>
            </div>
            <div class="input-group">
              <label>Tipo de Holder</label>
              <select onchange="actualizarTier(${tier.id}, 'tipoHolder', this.value)">
                <option value="persona_natural" ${tier.tipoHolder === 'persona_natural' ? 'selected' : ''}>Persona Natural</option>
                <option value="empresa" ${tier.tipoHolder === 'empresa' ? 'selected' : ''}>Empresa</option>
              </select>
            </div>
            <div class="input-group">
              <label>% Retenci√≥n Impuestos (%)</label>
              <input type="number" min="0" max="99" step="0.1" value="${tier.retencion}"
                     onchange="actualizarTier(${tier.id}, 'retencion', parseFloat(this.value) || 0)">
            </div>
          </div>
        `;
        
        container.appendChild(tierEl);
      });
      
      // Re-aplicar formateo a money inputs
      attachMoneyInputs();
    }
    
    function attachMoneyInputs() {
      const moneyInputs = document.querySelectorAll('.money-input[data-tier-id]');
      
      moneyInputs.forEach(input => {
        // Remover listeners anteriores clonando
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);
        
        newInput.addEventListener('input', debounce((e) => {
          const value = cleanNumber(e.target.value);
          e.target.value = value.toLocaleString('es-CL');
          
          const tierId = e.target.getAttribute('data-tier-id');
          const field = e.target.getAttribute('data-field');
          if (tierId && field) {
            actualizarTier(parseInt(tierId), field, value);
          }
        }, 400));
      });
    }
    
    // ==================== C√ÅLCULOS MATEM√ÅTICOS ====================
    
    function calcularTIR(flujos, maxIter = 100, tolerancia = 0.0001) {
      if (flujos.length === 0) return null;
      
      let r = 0.1;
      
      for (let iter = 0; iter < maxIter; iter++) {
        let van = 0;
        let vanDerivada = 0;
        
        flujos.forEach(f => {
          const t = f.mes / 12;
          van += f.monto / Math.pow(1 + r, t);
          vanDerivada -= (t * f.monto) / Math.pow(1 + r, t + 1);
        });
        
        if (Math.abs(van) < tolerancia) {
          return r;
        }
        
        if (vanDerivada === 0) break;
        
        r = r - van / vanDerivada;
        
        if (r < -0.99) r = -0.99;
        if (r > 10) r = 10;
      }
      
      return null;
    }
    
    function calcularVAN(flujos, tasaAnual) {
      let van = 0;
      flujos.forEach(f => {
        const t = f.mes / 12;
        van += f.monto / Math.pow(1 + tasaAnual, t);
      });
      return van;
    }
    
    function getIngresoMensual(mes, ingresos) {
      const a√±o = getA√±oFromMes(mes);
      if (a√±o <= 5) {
        return ingresos[a√±o - 1];
      } else {
        return ingresos[4];
      }
    }
    
    function getDividendoMensual(mes, ingresos, margenNeto, pctDistribuir, pctParticipacion, retencionDec) {
      const ingreso = getIngresoMensual(mes, ingresos);
      const utilidadMensual = ingreso * margenNeto;
      const utilidadDistribuir = utilidadMensual * pctDistribuir;
      const dividendoBruto = utilidadDistribuir * pctParticipacion;
      const dividendoNeto = dividendoBruto * (1 - retencionDec);
      
      return {
        bruto: dividendoBruto,
        neto: dividendoNeto
      };
    }
    
    // ==================== C√ÅLCULO PRINCIPAL ====================
    
    function calcularTodo() {
      if (!validarEquity()) {
        console.warn('Equity inv√°lido');
        return;
      }
      
      // Obtener inputs
      const nombreProyecto = document.getElementById('nombreProyecto').value.trim() || 'Proyecto Sin Nombre';
      document.getElementById('displayNombreProyecto').textContent = nombreProyecto;
      
      const pctInversores = parseFloat(document.getElementById('pctInversores').value) / 100 || 0;
      const pctControlador = parseFloat(document.getElementById('pctControlador').value) / 100 || 0;
      
      const ingresos = [
        cleanNumber(document.getElementById('ingresoA√±o1').value),
        cleanNumber(document.getElementById('ingresoA√±o2').value),
        cleanNumber(document.getElementById('ingresoA√±o3').value),
        cleanNumber(document.getElementById('ingresoA√±o4').value),
        cleanNumber(document.getElementById('ingresoA√±o5').value)
      ];
      
      const margenNeto = parseFloat(document.getElementById('margenNeto').value) / 100 || 0;
      const pctDistribuir = parseFloat(document.getElementById('pctDistribuir').value) / 100 || 0;
      
      const capitalCtrl = cleanNumber(document.getElementById('ctrlCapitalInicial').value);
      const tipoHolderCtrl = document.getElementById('ctrlTipoHolder').value;
      const retencionCtrl = parseFloat(document.getElementById('ctrlRetencion').value) / 100 || 0;
      
      const tasaDescuento = parseFloat(document.getElementById('tasaDescuento').value) / 100 || 0;
      
      // Calcular capital total inversores
      const capitalTotalInversores = tiers.reduce((sum, t) => sum + (t.monto * t.cantidad), 0);
      
      // Calcular resultados por tier
      const resultadosTiers = tiers.map(tier => {
        const pctParticipacion = (tier.monto * tier.cantidad / capitalTotalInversores) * pctInversores;
        const retencionDec = tier.retencion / 100;
        
        let detalleMensual = [];
        let acumuladoNeto = -tier.monto;
        let mesPayback = null;
        
        for (let mes = 1; mes <= 120; mes++) {
          if (mes < tier.mesRetornos) {
            detalleMensual.push({
              mes: mes,
              a√±oMes: `A√±o ${getA√±oFromMes(mes)} M${((mes - 1) % 12) + 1}`,
              bruto: 0,
              neto: 0,
              acumulado: acumuladoNeto,
              esPayback: false
            });
            continue;
          }
          
          const div = getDividendoMensual(mes, ingresos, margenNeto, pctDistribuir, pctParticipacion, retencionDec);
          acumuladoNeto += div.neto;
          
          const esPayback = mesPayback === null && acumuladoNeto >= 0;
          if (esPayback) mesPayback = mes;
          
          detalleMensual.push({
            mes: mes,
            a√±oMes: `A√±o ${getA√±oFromMes(mes)} M${((mes - 1) % 12) + 1}`,
            bruto: div.bruto,
            neto: div.neto,
            acumulado: acumuladoNeto,
            esPayback: esPayback
          });
        }
        
        // Calcular m√©tricas
        const retornoMensualNeto = detalleMensual.find(d => d.mes === 60)?.neto || 0;
        const retornoAnualNeto = retornoMensualNeto * 12;
        const roiAnual = tier.monto > 0 ? (retornoAnualNeto / tier.monto) : 0;
        
        // TIR
        const flujosTIR = [{ mes: tier.mesInversion, monto: -tier.monto }];
        for (let mes = tier.mesRetornos; mes <= 120; mes++) {
          const detail = detalleMensual.find(d => d.mes === mes);
          if (detail) {
            flujosTIR.push({ mes: mes, monto: detail.neto });
          }
        }
        const tir = calcularTIR(flujosTIR);
        
        // VAN
        const van = calcularVAN(flujosTIR, tasaDescuento);
        
        // Validaciones legales
        const roiIlegal = tier.tipoHolder === 'persona_natural' && roiAnual > 0.5;
        
        return {
          tier: tier,
          pctParticipacion: pctParticipacion,
          detalleMensual: detalleMensual,
          mesPayback: mesPayback,
          retornoMensualNeto: retornoMensualNeto,
          retornoAnualNeto: retornoAnualNeto,
          roiAnual: roiAnual,
          tir: tir,
          van: van,
          roiIlegal: roiIlegal
        };
      });
      
      // Calcular controlador
      const pctParticipacionCtrl = pctControlador;
      const retencionCtrlDec = retencionCtrl;
      
      const divCtrlEstable = getDividendoMensual(60, ingresos, margenNeto, pctDistribuir, pctParticipacionCtrl, retencionCtrlDec);
      const retornoMensualNetoCtrl = divCtrlEstable.neto;
      const retornoAnualNetoCtrl = retornoMensualNetoCtrl * 12;
      
      // TIR y VAN controlador (solo si hay capital inicial)
      let tirCtrl = null;
      let vanCtrl = null;
      if (capitalCtrl > 0) {
        const flujosTIRCtrl = [{ mes: 0, monto: -capitalCtrl }];
        for (let mes = 1; mes <= 120; mes++) {
          const div = getDividendoMensual(mes, ingresos, margenNeto, pctDistribuir, pctParticipacionCtrl, retencionCtrlDec);
          flujosTIRCtrl.push({ mes: mes, monto: div.neto });
        }
        tirCtrl = calcularTIR(flujosTIRCtrl);
        vanCtrl = calcularVAN(flujosTIRCtrl, tasaDescuento);
      }
      
      const valorEmpresa = (ingresos[4] * 12 * margenNeto) / tasaDescuento;
      const valorParticipacionCtrl = valorEmpresa * pctParticipacionCtrl;
      
      // Calcular m√©tricas resumen
      const capitalLevantado = capitalTotalInversores;
      const paybackPonderado = resultadosTiers.reduce((sum, r) => {
        if (r.mesPayback) {
          return sum + (r.mesPayback * r.tier.monto * r.tier.cantidad);
        }
        return sum;
      }, 0) / capitalLevantado;
      
      const roiPromedio = resultadosTiers.reduce((sum, r) => {
        return sum + (r.roiAnual * r.tier.monto * r.tier.cantidad);
      }, 0) / capitalLevantado;
      
      const tirPromedio = resultadosTiers.reduce((sum, r) => {
        if (r.tir !== null) {
          return sum + (r.tir * r.tier.monto * r.tier.cantidad);
        }
        return sum;
      }, 0) / capitalLevantado;
      
      const vanTotal = resultadosTiers.reduce((sum, r) => sum + r.van, 0);
      
      // Renderizar resultados
      renderMetricsResumen(capitalLevantado, pctInversores, paybackPonderado, roiPromedio, tirPromedio, vanTotal, valorEmpresa);
      renderTiersResults(resultadosTiers);
      renderControladorResults(pctParticipacionCtrl, valorParticipacionCtrl, divCtrlEstable.bruto, retornoMensualNetoCtrl, retornoAnualNetoCtrl, tirCtrl, vanCtrl);
      renderChart(resultadosTiers, { 
        ingresos, 
        margenNeto, 
        pctDistribuir, 
        pctParticipacionCtrl, 
        retencionCtrlDec 
      }, tasaDescuento);
    }
    
    // ==================== RENDER RESULTADOS ====================
    
    function renderMetricsResumen(capitalLevantado, pctInversores, paybackPonderado, roiPromedio, tirPromedio, vanTotal, valorEmpresa) {
      document.getElementById('metricCapital').textContent = formatMoney(capitalLevantado);
      document.getElementById('metricCapitalPct').textContent = formatPercent(pctInversores, 1) + ' equity';
      document.getElementById('metricPayback').textContent = paybackPonderado ? paybackPonderado.toFixed(1) + ' meses' : '‚Äî';
      document.getElementById('metricROI').textContent = formatPercent(roiPromedio, 1);
      document.getElementById('metricTIR').textContent = tirPromedio ? formatPercent(tirPromedio, 1) : '‚Äî';
      document.getElementById('metricVAN').textContent = formatMoney(vanTotal);
      document.getElementById('metricValor').textContent = formatMoney(valorEmpresa);
    }
    
    function renderTiersResults(resultadosTiers) {
      const container = document.getElementById('tiersResultsContainer');
      container.innerHTML = '';
      
      resultadosTiers.forEach((res, index) => {
        const card = document.createElement('section');
        card.className = 'result-card';
        card.setAttribute('data-tier-index', index);
        
        const roiIlegalHTML = res.roiIlegal ? 
          `<div class="card-metric-subtext warning-legal">‚ö†Ô∏è ROI > 50% ilegal persona natural</div>` : '';
        
        card.innerHTML = `
          <div class="card-header">
            <div class="card-tier-label">${res.tier.nombre}</div>
            <h2 class="card-title">${res.tier.cantidad}x <span class="amount">${formatMoney(res.tier.monto)}</span> = ${formatMoney(res.tier.monto * res.tier.cantidad)}</h2>
          </div>
          
          <div class="card-grid">
            <div class="card-metric">
              <span class="card-metric-label">% Participaci√≥n</span>
              <div class="card-metric-value">${formatPercent(res.pctParticipacion, 2)}</div>
              <div class="card-metric-subtext">Del equity total</div>
            </div>
            <div class="card-metric">
              <span class="card-metric-label">Payback</span>
              <div class="card-metric-value">${res.mesPayback ? res.mesPayback + ' meses' : 'N/A'}</div>
              <div class="card-metric-subtext">${res.mesPayback ? 'A√±o ' + getA√±oFromMes(res.mesPayback) : 'No alcanza'}</div>
            </div>
            <div class="card-metric">
              <span class="card-metric-label">Retorno Mensual NETO</span>
              <div class="card-metric-value highlight">${formatMoney(res.retornoMensualNeto)}</div>
              <div class="card-metric-subtext">A√±o 5 estabilizado</div>
            </div>
            <div class="card-metric">
              <span class="card-metric-label">Retorno Anual NETO</span>
              <div class="card-metric-value highlight">${formatMoney(res.retornoAnualNeto)}</div>
              <div class="card-metric-subtext">A√±o 5 estabilizado</div>
            </div>
            <div class="card-metric">
              <span class="card-metric-label">ROI Anual</span>
              <div class="card-metric-value ${res.roiIlegal ? 'text-warning-legal' : ''}">${formatPercent(res.roiAnual, 1)}</div>
              ${roiIlegalHTML}
            </div>
            <div class="card-metric">
              <span class="card-metric-label">TIR</span>
              <div class="card-metric-value">${res.tir !== null ? formatPercent(res.tir, 1) : 'N/A'}</div>
              <div class="card-metric-subtext">10 a√±os</div>
            </div>
            <div class="card-metric">
              <span class="card-metric-label">VAN</span>
              <div class="card-metric-value">${formatMoney(res.van)}</div>
              <div class="card-metric-subtext">Valor creado</div>
            </div>
          </div>
          
          <div class="detalle-toggle">
            <button class="btn-toggle-detalle" onclick="toggleDetalle(${res.tier.id})">
              üìã Ver Detalle Mensual
            </button>
            <div class="detalle-content" id="detalle-${res.tier.id}">
              <table class="detalle-table">
                <thead>
                  <tr>
                    <th>Mes</th>
                    <th>Per√≠odo</th>
                    <th>Dividendo Bruto</th>
                    <th>Dividendo Neto</th>
                    <th>Acumulado Neto</th>
                  </tr>
                </thead>
                <tbody id="detalle-tbody-${res.tier.id}"></tbody>
              </table>
              <button class="btn-load-more" id="load-more-${res.tier.id}" onclick="loadMoreDetalle(${res.tier.id})">
                Cargar m√°s meses
              </button>
            </div>
          </div>
        `;
        
        container.appendChild(card);
      });
    }
    
    function renderControladorResults(pct, valor, retiroBruto, retiroNeto, anualNeto, tir, van) {
      document.getElementById('ctrlResultPct').textContent = formatPercent(pct, 2);
      document.getElementById('ctrlResultValor').textContent = formatMoney(valor);
      document.getElementById('ctrlResultPctSub').textContent = formatPercent(pct, 2) + ' empresa';
      document.getElementById('ctrlResultRetiroNeto').textContent = formatMoney(retiroNeto);
      document.getElementById('ctrlResultRetiroBruto').textContent = 'Bruto: ' + formatMoney(retiroBruto);
      document.getElementById('ctrlResultAnual').textContent = formatMoney(anualNeto);
      document.getElementById('ctrlResultTIR').textContent = tir !== null ? formatPercent(tir, 1) : 'N/A';
      document.getElementById('ctrlResultVAN').textContent = van !== null ? formatMoney(van) : 'N/A';
    }
    
    // ==================== DETALLE MENSUAL ====================
    
    const detalleState = {};
    
    function toggleDetalle(tierId) {
      const content = document.getElementById('detalle-' + tierId);
      const isExpanded = content.classList.contains('expanded');
      
      if (!isExpanded) {
        content.classList.add('expanded');
        if (!detalleState[tierId]) {
          loadMoreDetalle(tierId);
        }
      } else {
        content.classList.remove('expanded');
      }
    }
    
    function loadMoreDetalle(tierId) {
      const tier = tiers.find(t => t.id === tierId);
      if (!tier) return;
      
      // Recalcular para obtener detalleMensual (simplificado)
      const ingresos = [
        cleanNumber(document.getElementById('ingresoA√±o1').value),
        cleanNumber(document.getElementById('ingresoA√±o2').value),
        cleanNumber(document.getElementById('ingresoA√±o3').value),
        cleanNumber(document.getElementById('ingresoA√±o4').value),
        cleanNumber(document.getElementById('ingresoA√±o5').value)
      ];
      
      const margenNeto = parseFloat(document.getElementById('margenNeto').value) / 100 || 0;
      const pctDistribuir = parseFloat(document.getElementById('pctDistribuir').value) / 100 || 0;
      const pctInversores = parseFloat(document.getElementById('pctInversores').value) / 100 || 0;
      
      const capitalTotalInversores = tiers.reduce((sum, t) => sum + (t.monto * t.cantidad), 0);
      const pctParticipacion = (tier.monto * tier.cantidad / capitalTotalInversores) * pctInversores;
      const retencionDec = tier.retencion / 100;
      
      let detalleMensual = [];
      let acumuladoNeto = -tier.monto;
      let mesPayback = null;
      
      for (let mes = 1; mes <= 120; mes++) {
        if (mes < tier.mesRetornos) {
          detalleMensual.push({
            mes: mes,
            a√±oMes: `A√±o ${getA√±oFromMes(mes)} M${((mes - 1) % 12) + 1}`,
            bruto: 0,
            neto: 0,
            acumulado: acumuladoNeto,
            esPayback: false
          });
          continue;
        }
        
        const div = getDividendoMensual(mes, ingresos, margenNeto, pctDistribuir, pctParticipacion, retencionDec);
        acumuladoNeto += div.neto;
        
        const esPayback = mesPayback === null && acumuladoNeto >= 0;
        if (esPayback) mesPayback = mes;
        
        detalleMensual.push({
          mes: mes,
          a√±oMes: `A√±o ${getA√±oFromMes(mes)} M${((mes - 1) % 12) + 1}`,
          bruto: div.bruto,
          neto: div.neto,
          acumulado: acumuladoNeto,
          esPayback: esPayback
        });
      }
      
      // Renderizar tabla
      const tbody = document.getElementById('detalle-tbody-' + tierId);
      const loadMoreBtn = document.getElementById(`load-more-${tierId}`);
      
      if (!detalleState[tierId]) {
        detalleState[tierId] = { expanded: true, loaded: 0 };
      }
      
      const start = detalleState[tierId].loaded;
      const end = Math.min(start + 24, detalleMensual.length);
      
      for (let i = start; i < end; i++) {
        const d = detalleMensual[i];
        const row = tbody.insertRow();
        if (d.esPayback) row.className = 'payback-row';
        
        row.innerHTML = `
          <td>${d.mes}</td>
          <td>${d.a√±oMes}</td>
          <td>${formatMoney(d.bruto)}</td>
          <td>${formatMoney(d.neto)}</td>
          <td>${formatMoney(d.acumulado)}</td>
        `;
      }
      
      detalleState[tierId].loaded = end;
      
      if (end >= detalleMensual.length) {
        loadMoreBtn.classList.add('hidden');
      } else {
        loadMoreBtn.classList.remove('hidden');
      }
    }
    
    // ==================== GR√ÅFICO ====================
    
    function renderChart(resultadosTiers, controladorData, tasaDescuento) {
      const ctx = document.getElementById('vanChart');
      
      const trimestres = [];
      for (let mes = 0; mes <= 120; mes += 3) {
        trimestres.push(mes);
      }
      
      const datasets = [];
      
      resultadosTiers.forEach((res, index) => {
        const data = trimestres.map(mes => {
          const flujos = [{ mes: res.tier.mesInversion, monto: -res.tier.monto }];
          for (let m = res.tier.mesRetornos; m <= mes; m++) {
            const detail = res.detalleMensual.find(d => d.mes === m);
            if (detail) {
              flujos.push({ mes: m, monto: detail.neto });
            }
          }
          return calcularVAN(flujos, tasaDescuento);
        });
        
        const colors = ['#4F46E5', '#0891B2', '#7C3AED', '#DB2777', '#059669'];
        
        datasets.push({
          label: res.tier.nombre,
          data: data,
          borderColor: colors[index % colors.length],
          backgroundColor: 'transparent',
          borderWidth: 2,
          tension: 0.3
        });
      });
      
      if (controladorData) {
        const dataCtrl = trimestres.map(mes => {
          const flujos = [{ mes: 0, monto: -cleanNumber(document.getElementById('ctrlCapitalInicial').value) }];
          for (let m = 1; m <= mes; m++) {
            const div = getDividendoMensual(m, controladorData.ingresos, controladorData.margenNeto, 
                                           controladorData.pctDistribuir, controladorData.pctParticipacionCtrl, 
                                           controladorData.retencionCtrlDec);
            flujos.push({ mes: m, monto: div.neto });
          }
          return calcularVAN(flujos, tasaDescuento);
        });
        
        datasets.push({
          label: 'Controlador',
          data: dataCtrl,
          borderColor: '#047857',
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [5, 5],
          tension: 0.3
        });
      }
      
      if (vanChart) {
        vanChart.destroy();
      }
      
      vanChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: trimestres.map(m => `M${m}`),
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 12,
                padding: 10,
                font: { size: 11 }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(17, 24, 39, 0.95)',
              titleFont: { size: 12, weight: '600' },
              bodyFont: { size: 12 },
              padding: 10,
              cornerRadius: 4,
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + formatMoney(context.parsed.y);
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { font: { size: 11 } }
            },
            y: {
              grid: { color: '#F3F4F6' },
              ticks: { 
                font: { size: 11 },
                callback: function(value) {
                  return '$' + (value / 1000000).toFixed(1) + 'M';
                }
              }
            }
          }
        }
      });
    }
    
    // ==================== EXPORT PDF ====================
    
    function exportarPDF() {
      const nombreProyecto = document.getElementById('nombreProyecto').value.trim() || 'Proyecto';
      const fecha = new Date().toLocaleDateString('es-CL');
      
      const element = document.getElementById('mainContainer');
      
      const opt = {
        margin: 10,
        filename: `modelo_financiero_${nombreProyecto.replace(/\s+/g, '_')}_${fecha}.pdf`,
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { 
          scale: 1.5,
          useCORS: true,
          logging: false,
          width: element.scrollWidth,
          windowWidth: element.scrollWidth
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait',
          compress: true
        },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };
      
      html2pdf().set(opt).from(element).save();
    }
    
    // ==================== LIMPIAR ====================
    
    function limpiarFormulario() {
      if (!confirm('¬øSeguro que deseas limpiar todos los datos? Esta acci√≥n no se puede deshacer.')) {
        return;
      }
      
      document.getElementById('nombreProyecto').value = '';
      document.getElementById('pctInversores').value = '48';
      document.getElementById('pctControlador').value = '52';
      document.getElementById('ingresoA√±o1').value = '0';
      document.getElementById('ingresoA√±o2').value = '50.000.000';
      document.getElementById('ingresoA√±o3').value = '100.000.000';
      document.getElementById('ingresoA√±o4').value = '150.000.000';
      document.getElementById('ingresoA√±o5').value = '150.000.000';
      document.getElementById('margenNeto').value = '25';
      document.getElementById('pctDistribuir').value = '80';
      document.getElementById('ctrlCapitalInicial').value = '0';
      document.getElementById('ctrlTipoHolder').value = 'persona_natural';
      document.getElementById('ctrlRetencion').value = '10';
      document.getElementById('tasaDescuento').value = '12';
      
      tiers = [];
      nextTierId = 1;
      agregarTier();
      
      calcularTodo();
    }
    
    // ==================== FORMATO INPUTS MONEY ====================
    
    function setupMoneyInputs() {
      const moneyInputs = document.querySelectorAll('.money-input:not([data-tier-id])');
      
      moneyInputs.forEach(input => {
        input.addEventListener('input', debounce((e) => {
          const value = cleanNumber(e.target.value);
          e.target.value = value.toLocaleString('es-CL');
          calcularTodo();
        }, 400));
      });
    }
    
    // ==================== EVENTOS ====================
    
    document.getElementById('btnAddTier').addEventListener('click', agregarTier);
    document.getElementById('btnLimpiar').addEventListener('click', limpiarFormulario);
    document.getElementById('btnExportar').addEventListener('click', exportarPDF);
    
    document.getElementById('pctInversores').addEventListener('input', debounce(calcularTodo, 300));
    document.getElementById('pctControlador').addEventListener('input', debounce(calcularTodo, 300));
    document.getElementById('margenNeto').addEventListener('input', debounce(calcularTodo, 300));
    document.getElementById('pctDistribuir').addEventListener('input', debounce(calcularTodo, 300));
    document.getElementById('ctrlTipoHolder').addEventListener('change', calcularTodo);
    document.getElementById('ctrlRetencion').addEventListener('input', debounce(calcularTodo, 300));
    document.getElementById('tasaDescuento').addEventListener('input', debounce(calcularTodo, 300));
    
    document.getElementById('nombreProyecto').addEventListener('input', debounce(() => {
      const nombre = document.getElementById('nombreProyecto').value.trim() || 'Proyecto Sin Nombre';
      document.getElementById('displayNombreProyecto').textContent = nombre;
    }, 300));
    
    // ==================== INICIALIZACI√ìN ====================
    
    document.addEventListener('DOMContentLoaded', () => {
      // Agregar tier inicial
      agregarTier();
      
      // Setup money inputs
      setupMoneyInputs();
      
      // DETECTAR INGRESOS DESDE CALCULADORA M¬≤
      detectarYCargarIngresos();
      
      // Calcular inicial
      calcularTodo();
    });
    
  </script>

</body>
</html>
